DROP TABLE CIERRE_MES_CLIENTE PURGE;

CREATE TABLE CIERRE_MES_CLIENTE AS 
WITH BASE_FIJA AS (
SELECT 
  CASE
    WHEN A.FUENTE = 'T' THEN 'AFINIDAD DNI'
    WHEN A.RUCCOMPANIA = '20100039037' THEN 'AFINIDAD GR'
    ELSE 'NO AFINIDAD'
  END AFINIDAD,
  CASE 
    WHEN A.FUENTE LIKE '%PROV%' THEN 'CONTABLE'
    WHEN A.FUENTE LIKE '%EXT%' THEN 'CONTABLE'
    WHEN A.FUENTE LIKE '%CONTA%' THEN 'CONTABLE'
    ELSE 'GESTIONAL'
  END FUENTE,
  CASE
    WHEN A.CORTEPL4 = 'ONE SHOT REDES Y DATOS' THEN 'ONE SHOT'
    WHEN A.TECNOLOGIA2 = 'SEGURIDAD' AND A.CORTEPL5 = 'EDR' THEN 'SEGURIDAD GESTIONADA'
    WHEN A.TECNOLOGIA2 = 'SEGURIDAD' THEN A.CORTEPL5
    ELSE A.TECNOLOGIA2
  END AS VISTA_IDG,
  A.CORTEPL3 VISTA_IDG0, 
  'Ingresos Fijos' VISTA_IDG1, 
  A.TECNOLOGIA2 TECNOLOGIA_PANEL,
  A.RUCCOMPANIA,
  --B.RAZONSOCIAL,
  C.RS_CARTERA_CANAL_N1,
  C.RS_CARTERA_CANAL_N2,
  C.RS_CARTERA_CANAL_N3,
  C.RS_CARTERA_CANAL_N4,
  C.RS_CARTERA_CANAL_N5,
  D.NEW_SEGMENTO_2021,
  D.NEW_SUBSEGMENTO_2021,
  D.GOBIERNO,
  SUM(DECODE(A.PERIODO, '202501',A.montoservicioscontratadosnew,0)) M_202501,
  SUM(DECODE(A.PERIODO, '202502',A.montoservicioscontratadosnew,0)) M_202502,
  SUM(DECODE(A.PERIODO, '202503',A.montoservicioscontratadosnew,0)) M_202503,
  SUM(DECODE(A.PERIODO, '202504',A.montoservicioscontratadosnew,0)) M_202504,
  SUM(DECODE(A.PERIODO, '202505',A.montoservicioscontratadosnew,0)) M_202505,
  SUM(DECODE(A.PERIODO, '202506',A.montoservicioscontratadosnew,0)) M_202506,
  SUM(DECODE(A.PERIODO, '202507',A.montoservicioscontratadosnew,0)) M_202507,
  SUM(DECODE(A.PERIODO, '202508',A.montoservicioscontratadosnew,0)) M_202508,
  SUM(DECODE(A.PERIODO, '202509',A.montoservicioscontratadosnew,0)) M_202509,
  SUM(DECODE(A.PERIODO, '202510',A.montoservicioscontratadosnew,0)) M_202510,
  SUM(DECODE(A.PERIODO, '202511',A.montoservicioscontratadosnew,0)) M_202511,
  SUM(DECODE(A.PERIODO, '202512',A.montoservicioscontratadosnew,0)) M_202512
FROM tmp_cge_ingconvergente_v2 A
  LEFT JOIN cge_tbsegmento_cierre D
    ON D.RUC_DNI = A.RUCCOMPANIA AND D.PERIODO = A.PERIODO
  --LEFT JOIN V_MAESTRO_RZ_EXPORT B
  --  ON B.RUCCOMPANIA = A.RUCCOMPANIA
  LEFT JOIN CGE_TBCARTERA_CIERRE C
    ON C.RUCCOMPANIA = A.RUCCOMPANIA AND C.PERIODO = A.PERIODO
WHERE 1=1
  AND A.PERIODO >= '202501' AND A.PERIODO <= '202512'
  AND A.FUENTE LIKE 'FIJA%'
  AND A.CORTEPL2 = 'NEGOCIO FIJO'
GROUP BY 
  CASE
    WHEN A.FUENTE = 'T' THEN 'AFINIDAD DNI'
    WHEN A.RUCCOMPANIA = '20100039037' THEN 'AFINIDAD GR'
    ELSE 'NO AFINIDAD'
  END ,
  CASE 
    WHEN A.FUENTE LIKE '%PROV%' THEN 'CONTABLE'
    WHEN A.FUENTE LIKE '%EXT%' THEN 'CONTABLE'
    WHEN A.FUENTE LIKE '%CONTA%' THEN 'CONTABLE'
    ELSE 'GESTIONAL'
  END ,
  CASE
    WHEN A.CORTEPL4 = 'ONE SHOT REDES Y DATOS' THEN 'ONE SHOT'
    WHEN A.TECNOLOGIA2 = 'SEGURIDAD' AND A.CORTEPL5 = 'EDR' THEN 'SEGURIDAD GESTIONADA'
    WHEN A.TECNOLOGIA2 = 'SEGURIDAD' THEN A.CORTEPL5
    ELSE A.TECNOLOGIA2
  END ,
  A.CORTEPL3 , 
  A.TECNOLOGIA2 ,
  A.RUCCOMPANIA,
  --B.RAZONSOCIAL,
  C.RS_CARTERA_CANAL_N1,
  C.RS_CARTERA_CANAL_N2,
  C.RS_CARTERA_CANAL_N3,
  C.RS_CARTERA_CANAL_N4,
  C.RS_CARTERA_CANAL_N5,
  D.NEW_SEGMENTO_2021,
  D.NEW_SUBSEGMENTO_2021,
  D.GOBIERNO
),
BASE_PYME AS (
SELECT 
  CASE
    WHEN A.FLAG_FUENTE = 'T' THEN 'AFINIDAD DNI'
    WHEN A.RUCCOMPANIA = '20100039037' THEN 'AFINIDAD GR'
    ELSE 'NO AFINIDAD'
  END AFINIDAD,
  CASE 
    WHEN A.FLAG_FUENTE LIKE '%PROV%' THEN 'CONTABLE'
    WHEN A.FLAG_FUENTE LIKE '%EXT%' THEN 'CONTABLE'
    ELSE 'GESTIONAL'
  END FUENTE,
  DECODE(A.VISTA_IDG,'Ingresos Fijos','Ingresos Pyme',A.VISTA_IDG) VISTA_IDG,
  'PRODUCTO MASIVO' VISTA_IDG0, 
  A.VISTA_IDG1, 
  DECODE(A.TECNOLOGIA_PANEL,'HOGAR','BAFI',A.TECNOLOGIA_PANEL) TECNOLOGIA_PANEL,
  DECODE(A.FLAG_FUENTE,'T',A.RUCAFINIDAD,NVL(A.RUCCOMPANIA,D.CSCOMPTAXNO)) RUCCOMPANIA,
  --NVL(TRIM(A.RAZONSOCIAL),B.RAZONSOCIAL) RAZONSOCIAL,
  C.RS_CARTERA_CANAL_N1,
  C.RS_CARTERA_CANAL_N2,
  C.RS_CARTERA_CANAL_N3,
  C.RS_CARTERA_CANAL_N4,
  C.RS_CARTERA_CANAL_N5,
  A.NEW_SEGMENTO_2021,
  A.NEW_SUBSEGMENTO_2021,
  A.GOBIERNO,
  SUM(DECODE(A.PERIODO, '202501',A.MONTOFACTURADO,0)) M_202501,
  SUM(DECODE(A.PERIODO, '202502',A.MONTOFACTURADO,0)) M_202502,
  SUM(DECODE(A.PERIODO, '202503',A.MONTOFACTURADO,0)) M_202503,
  SUM(DECODE(A.PERIODO, '202504',A.MONTOFACTURADO,0)) M_202504,
  SUM(DECODE(A.PERIODO, '202505',A.MONTOFACTURADO,0)) M_202505,
  SUM(DECODE(A.PERIODO, '202506',A.MONTOFACTURADO,0)) M_202506,
  SUM(DECODE(A.PERIODO, '202507',A.MONTOFACTURADO,0)) M_202507,
  SUM(DECODE(A.PERIODO, '202508',A.MONTOFACTURADO,0)) M_202508,
  SUM(DECODE(A.PERIODO, '202509',A.MONTOFACTURADO,0)) M_202509,
  SUM(DECODE(A.PERIODO, '202510',A.MONTOFACTURADO,0)) M_202510,
  SUM(DECODE(A.PERIODO, '202511',A.MONTOFACTURADO,0)) M_202511,
  SUM(DECODE(A.PERIODO, '202512',A.MONTOFACTURADO,0)) M_202512
FROM ODS_CDG.Cg_Convergente_B2b A
  LEFT JOIN CUSTOMER_ALL@PBSCS_LM.WORLD D
    ON D.CUSTCODE = DECODE(A.NUMEROCUENTARESPONSABLE,'4.9596.210000000000','4.9596.21',A.NUMEROCUENTARESPONSABLE)
  --LEFT JOIN V_MAESTRO_RZ_EXPORT B
  --  ON B.RUCCOMPANIA = DECODE(A.FLAG_FUENTE,'T',A.RUCAFINIDAD,NVL(A.RUCCOMPANIA,D.CSCOMPTAXNO))
  LEFT JOIN CGE_TBCARTERA_CIERRE C
    ON C.RUCCOMPANIA = A.RUCCOMPANIA AND C.PERIODO = A.PERIODO
  
WHERE 1=1
  AND A.PERIODO >= '202501' AND A.PERIODO <= '202512'
  AND UPPER(A.VISTA_IDG1) LIKE '%INGRESOS FIJO%'
GROUP BY 
  CASE
    WHEN A.FLAG_FUENTE = 'T' THEN 'AFINIDAD DNI'
    WHEN A.RUCCOMPANIA = '20100039037' THEN 'AFINIDAD GR'
    ELSE 'NO AFINIDAD'
  END,
  CASE 
    WHEN A.FLAG_FUENTE LIKE '%PROV%' THEN 'CONTABLE'
    WHEN A.FLAG_FUENTE LIKE '%EXT%' THEN 'CONTABLE'
    ELSE 'GESTIONAL'
  END,
  DECODE(A.VISTA_IDG,'Ingresos Fijos','Ingresos Pyme',A.VISTA_IDG) ,
  --DECODE(A.VISTA_IDG0,'Ingresos Fijos','Ingresos Pyme',A.VISTA_IDG0) , 
  A.VISTA_IDG1, 
  DECODE(A.TECNOLOGIA_PANEL,'HOGAR','BAFI',A.TECNOLOGIA_PANEL),
  DECODE(A.FLAG_FUENTE,'T',A.RUCAFINIDAD,NVL(A.RUCCOMPANIA,D.CSCOMPTAXNO)),
  --NVL(TRIM(A.RAZONSOCIAL),B.RAZONSOCIAL),
  C.RS_CARTERA_CANAL_N1,
  C.RS_CARTERA_CANAL_N2,
  C.RS_CARTERA_CANAL_N3,
  C.RS_CARTERA_CANAL_N4,
  C.RS_CARTERA_CANAL_N5,
  A.NEW_SEGMENTO_2021,
  A.NEW_SUBSEGMENTO_2021,
  A.GOBIERNO
),
BASE_MOVIL AS (
SELECT 
  CASE
    WHEN A.FLAG_FUENTE = 'T' THEN 'AFINIDAD DNI'
    WHEN A.RUCCOMPANIA = '20100039037' THEN 'AFINIDAD GR'
    ELSE 'NO AFINIDAD'
  END AFINIDAD,
  CASE 
    WHEN A.FLAG_FUENTE LIKE '%PROV%' THEN 'CONTABLE'
    WHEN A.FLAG_FUENTE LIKE '%EXT%' THEN 'CONTABLE'
    ELSE 'GESTIONAL'
  END FUENTE,
  A.VISTA_IDG, 
  CASE 
    WHEN UPPER(A.VISTA_IDG) LIKE '%CARGO B%SICO%' THEN 'CARGO BASICO NETO'
    WHEN UPPER(A.VISTA_IDG) LIKE '%DESCUENTO%' THEN 'CARGO BASICO NETO'
    ELSE A.VISTA_IDG0
  END AS VISTA_IDG0, 
  A.VISTA_IDG1, A.TECNOLOGIA_PANEL,
  DECODE(A.FLAG_FUENTE,'T',A.RUCAFINIDAD,NVL(A.RUCCOMPANIA,D.CSCOMPTAXNO)) RUCCOMPANIA,
  --NVL(TRIM(A.RAZONSOCIAL),B.RAZONSOCIAL) RAZONSOCIAL,
  C.RS_CARTERA_CANAL_N1,
  C.RS_CARTERA_CANAL_N2,
  C.RS_CARTERA_CANAL_N3,
  C.RS_CARTERA_CANAL_N4,
  C.RS_CARTERA_CANAL_N5,
  A.NEW_SEGMENTO_2021,
  A.NEW_SUBSEGMENTO_2021,
  A.GOBIERNO,
  SUM(DECODE(A.PERIODO, '202501',A.MONTOFACTURADO,0)) M_202501,
  SUM(DECODE(A.PERIODO, '202502',A.MONTOFACTURADO,0)) M_202502,
  SUM(DECODE(A.PERIODO, '202503',A.MONTOFACTURADO,0)) M_202503,
  SUM(DECODE(A.PERIODO, '202504',A.MONTOFACTURADO,0)) M_202504,
  SUM(DECODE(A.PERIODO, '202505',A.MONTOFACTURADO,0)) M_202505,
  SUM(DECODE(A.PERIODO, '202506',A.MONTOFACTURADO,0)) M_202506,
  SUM(DECODE(A.PERIODO, '202507',A.MONTOFACTURADO,0)) M_202507,
  SUM(DECODE(A.PERIODO, '202508',A.MONTOFACTURADO,0)) M_202508,
  SUM(DECODE(A.PERIODO, '202509',A.MONTOFACTURADO,0)) M_202509,
  SUM(DECODE(A.PERIODO, '202510',A.MONTOFACTURADO,0)) M_202510,
  SUM(DECODE(A.PERIODO, '202511',A.MONTOFACTURADO,0)) M_202511,
  SUM(DECODE(A.PERIODO, '202512',A.MONTOFACTURADO,0)) M_202512
FROM ODS_CDG.Cg_Convergente_B2b A
  LEFT JOIN CUSTOMER_ALL@PBSCS_LM.WORLD D
    ON D.CUSTCODE = DECODE(A.NUMEROCUENTARESPONSABLE,'4.9596.210000000000','4.9596.21',A.NUMEROCUENTARESPONSABLE)
  --LEFT JOIN V_MAESTRO_RZ_EXPORT B
  --  ON B.RUCCOMPANIA = DECODE(A.FLAG_FUENTE,'T',A.RUCAFINIDAD,NVL(A.RUCCOMPANIA,D.CSCOMPTAXNO))
  LEFT JOIN CGE_TBCARTERA_CIERRE C
    ON C.RUCCOMPANIA = A.RUCCOMPANIA AND C.PERIODO = A.PERIODO
WHERE 1=1
  AND A.PERIODO >= '202501' AND A.PERIODO <= '202512'
  AND UPPER(A.VISTA_IDG1) LIKE '%INGRESOS M%VILES%'
GROUP BY 
  CASE
    WHEN A.FLAG_FUENTE = 'T' THEN 'AFINIDAD DNI'
    WHEN A.RUCCOMPANIA = '20100039037' THEN 'AFINIDAD GR'
    ELSE 'NO AFINIDAD'
  END,
  CASE 
    WHEN A.FLAG_FUENTE LIKE '%PROV%' THEN 'CONTABLE'
    WHEN A.FLAG_FUENTE LIKE '%EXT%' THEN 'CONTABLE'
    ELSE 'GESTIONAL'
  END,
  A.VISTA_IDG, 
  CASE 
    WHEN UPPER(A.VISTA_IDG) LIKE '%CARGO B%SICO%' THEN 'CARGO BASICO NETO'
    WHEN UPPER(A.VISTA_IDG) LIKE '%DESCUENTO%' THEN 'CARGO BASICO NETO'
    ELSE A.VISTA_IDG0
  END, 
  A.VISTA_IDG1, A.TECNOLOGIA_PANEL,
  DECODE(A.FLAG_FUENTE,'T',A.RUCAFINIDAD,NVL(A.RUCCOMPANIA,D.CSCOMPTAXNO)),
  --NVL(TRIM(A.RAZONSOCIAL),B.RAZONSOCIAL),
  C.RS_CARTERA_CANAL_N1,
  C.RS_CARTERA_CANAL_N2,
  C.RS_CARTERA_CANAL_N3,
  C.RS_CARTERA_CANAL_N4,
  C.RS_CARTERA_CANAL_N5,
  A.NEW_SEGMENTO_2021,
  A.NEW_SUBSEGMENTO_2021,
  A.GOBIERNO
),
BASE1 AS (
SELECT * FROM BASE_FIJA
UNION ALL
SELECT * FROM BASE_PYME
UNION ALL
SELECT * FROM BASE_MOVIL
),
BASE_RUC_MONTO AS (
SELECT 
  VISTA_IDG1,
  RUCCOMPANIA,
  SUM(M_202501) M_202501,
  SUM(M_202502) M_202502,
  SUM(M_202503) M_202503,
  SUM(M_202504) M_202504,
  SUM(M_202505) M_202505,
  SUM(M_202506) M_202506,
  SUM(M_202507) M_202507,
  SUM(M_202508) M_202508,
  SUM(M_202509) M_202509,
  SUM(M_202510) M_202510,
  SUM(M_202511) M_202511,
  SUM(M_202512) M_202512
FROM BASE1 
GROUP BY VISTA_IDG1, RUCCOMPANIA
),
BASE_RUC_SITUACION AS (
SELECT 
  A.VISTA_IDG1,
  A.RUCCOMPANIA,
  CASE 
    WHEN A.M_202501 = 0 THEN 'CAPTURA'
    WHEN A.M_202512 = 0 THEN 'RETIRO'
    ELSE 'MANTIENE'
  END SITUACION,
  CASE 
    WHEN A.M_202501 <> 0 THEN '202501'
    WHEN A.M_202502 <> 0 THEN '202502'
    WHEN A.M_202503 <> 0 THEN '202503'
    WHEN A.M_202504 <> 0 THEN '202504'
    WHEN A.M_202505 <> 0 THEN '202505'
    WHEN A.M_202506 <> 0 THEN '202506'
    WHEN A.M_202507 <> 0 THEN '202507'
    WHEN A.M_202508 <> 0 THEN '202508'
    WHEN A.M_202509 <> 0 THEN '202509'
    WHEN A.M_202510 <> 0 THEN '202510'
    WHEN A.M_202511 <> 0 THEN '202511'
    WHEN A.M_202512 <> 0 THEN '202512'
  END ENTRADA,
  CASE 
    WHEN A.M_202501 = 0 THEN 'NO APLICA'
    WHEN (A.M_202502 + A.M_202503 + A.M_202504 + A.M_202505 + A.M_202506 + A.M_202507 + A.M_202508 + A.M_202509 + A.M_202510 + A.M_202511 + A.M_202512) = 0 THEN '202501'
    WHEN (A.M_202503 + A.M_202504 + A.M_202505 + A.M_202506 + A.M_202507 + A.M_202508 + A.M_202509 + A.M_202510 + A.M_202511 + A.M_202512) = 0 THEN '202502'
    WHEN (A.M_202504 + A.M_202505 + A.M_202506 + A.M_202507 + A.M_202508 + A.M_202509 + A.M_202510 + A.M_202511 + A.M_202512) = 0 THEN '202503'
    WHEN (A.M_202505 + A.M_202506 + A.M_202507 + A.M_202508 + A.M_202509 + A.M_202510 + A.M_202511 + A.M_202512) = 0 THEN '202504'
    WHEN (A.M_202506 + A.M_202507 + A.M_202508 + A.M_202509 + A.M_202510 + A.M_202511 + A.M_202512) = 0 THEN '202505'
    WHEN (A.M_202507 + A.M_202508 + A.M_202509 + A.M_202510 + A.M_202511 + A.M_202512) = 0 THEN '202506'
    WHEN (A.M_202508 + A.M_202509 + A.M_202510 + A.M_202511 + A.M_202512) = 0 THEN '202507'
    WHEN (A.M_202509 + A.M_202510 + A.M_202511 + A.M_202512) = 0 THEN '202508'
    WHEN (A.M_202510 + A.M_202511 + A.M_202512) = 0 THEN '202509'
    WHEN (A.M_202511 + A.M_202512) = 0 THEN '202510'
    WHEN (A.M_202512) = 0 THEN '202511'
    ELSE ''
  END SALIDA --MODIFICAR CADA MES
FROM BASE_RUC_MONTO A
),
BASE_FIN AS (
SELECT
  A.AFINIDAD,
  A.FUENTE,
  UPPER(A.VISTA_IDG) AS VISTA_IDG,
  UPPER(A.VISTA_IDG0) AS VISTA_IDG0, 
  UPPER(A.VISTA_IDG1) AS VISTA_IDG1, 
  A.TECNOLOGIA_PANEL,
  A.RUCCOMPANIA,
  C.RAZONSOCIAL,
  UPPER(A.RUCCOMPANIA || ' - ' || C.RAZONSOCIAL) AS RUC_RZ,
  A.RS_CARTERA_CANAL_N1,
  A.RS_CARTERA_CANAL_N2,
  A.RS_CARTERA_CANAL_N3,
  A.RS_CARTERA_CANAL_N4,
  A.RS_CARTERA_CANAL_N5,
  A.NEW_SEGMENTO_2021,
  A.NEW_SUBSEGMENTO_2021,
  A.GOBIERNO,
  A.M_202501,
  A.M_202502,
  A.M_202503,
  A.M_202504,
  A.M_202505,
  A.M_202506,
  A.M_202507,
  A.M_202508,
  A.M_202509,
  A.M_202510,
  A.M_202511,
  A.M_202512,
  (A.M_202512 - A.M_202511) VAR_202512,
  (A.M_202501 + A.M_202502 + A.M_202503 + A.M_202504 + A.M_202505 + A.M_202506 + A.M_202507 + A.M_202508 + A.M_202509 + A.M_202510 + A.M_202511 + A.M_202512) TOTAL_2025,
  B.SITUACION,
  B.ENTRADA,
  B.SALIDA
FROM BASE1 A
  LEFT JOIN BASE_RUC_SITUACION B
    ON A.RUCCOMPANIA = B.RUCCOMPANIA AND A.VISTA_IDG1 = B.VISTA_IDG1
  LEFT JOIN V_MAESTRO_RZ_EXPORT C
    ON C.RUCCOMPANIA = A.RUCCOMPANIA
)

SELECT * FROM BASE_FIN

;

SELECT * FROM CIERRE_MES_CLIENTE;

